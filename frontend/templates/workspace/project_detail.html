{% extends "base.html" %}

<!-- Define columns name to display from columns table -->
{% set column_titles = {
"room_name": "Salle",
"room_id": "ID Salle",

"interior_fenestration_id": "ID Fen√™tre Int√©rieure",
"interior_fenestration_category": "Cat√©gorie",
"interior_fenestration_number": "Num√©ro",
"interior_fenestration_name": "Nom",
"interior_fenestration_commentary": "Commentaire",
"interior_fenestration_quantity": "Quantit√©",

"exterior_fenestration_id": "ID Fen√™tre Ext√©rieure",
"exterior_fenestration_category": "Cat√©gorie",
"exterior_fenestration_number": "Num√©ro",
"exterior_fenestration_name": "Nom",
"exterior_fenestration_commentary": "Commentaire",
"exterior_fenestration_quantity": "Quantit√©",

"doors_id": "ID Porte",
"doors_category": "Cat√©gorie",
"doors_number": "Num√©ro",
"doors_name": "Nom",
"doors_commentary": "Commentaire",
"doors_quantity": "Quantit√©",

"built_in_furniture_id": "ID Mobilier int√©gr√©",
"built_in_furniture_category": "Cat√©gorie",
"built_in_furniture_number": "Num√©ro",
"built_in_furniture_name": "Nom",
"built_in_furniture_commentary": "Commentaire",
"built_in_furniture_quantity": "Quantit√©",

"accessories_id": "ID Accessoire",
"accessories_category": "Cat√©gorie",
"accessories_number": "Num√©ro",
"accessories_name": "Nom",
"accessories_commentary": "Commentaire",
"accessories_quantity": "Quantit√©",

"plumbings_id": "ID Plomberie",
"plumbings_category": "Cat√©gorie",
"plumbings_number": "Num√©ro",
"plumbings_name": "Nom",
"plumbings_commentary": "Commentaire",
"plumbings_quantity": "Quantit√©",

"fire_protection_id": "ID Protection Incendie",
"fire_protection_category": "Cat√©gorie",
"fire_protection_number": "Num√©ro",
"fire_protection_name": "Nom",
"fire_protection_commentary": "Commentaire",
"fire_protection_quantity": "Quantit√©",

"lighting_id": "ID √âclairage",
"lighting_category": "Cat√©gorie",
"lighting_number": "Num√©ro",
"lighting_name": "Nom",
"lighting_commentary": "Commentaire",
"lighting_quantity": "Quantit√©",

"electrical_outlets_id": "ID Prise √âlectrique",
"electrical_outlets_category": "Cat√©gorie",
"electrical_outlets_number": "Num√©ro",
"electrical_outlets_name": "Nom",
"electrical_outlets_commentary": "Commentaire",
"electrical_outlets_quantity": "Quantit√©",

"communication_security_id": "ID Communication & s√©curit√©",
"communication_security_category": "Cat√©gorie",
"communication_security_number": "Num√©ro",
"communication_security_name": "Nom",
"communication_security_commentary": "Commentaire",
"communication_security_quantity": "Quantit√©",

"medical_equipment_id": "ID √âquipement M√©dical",
"medical_equipment_category": "Cat√©gorie",
"medical_equipment_number": "Num√©ro",
"medical_equipment_name": "Nom",
"medical_equipment_commentary": "Commentaire",
"medical_equipment_quantity": "Quantit√©",

"electricity_id": "ID √âlectricit√©",
"electricity_care_area_type": "Type de Zone",
"electricity_smoke_fire_detection": "D√©tection Incendie",
"electricity_special_equipment": "√âquipement Sp√©cial",
"electricity_lighting_type": "Type d'√âclairage",
"electricity_lighting_level": "Niveau d'√âclairage",
"electricity_lighting_control": "Contr√¥le √âclairage",
"color_temperature": "Temp√©rature Couleur",
"electricity_lighting": "√âclairage",
"electricity_commentary": "Commentaire"
} %}

{% set tab_titles = {
"exterior_fenestration": "Fenestration Ext√©rieure",
"interior_fenestration": "Fenestration Int√©rieure",
"doors": "Portes",
"built_in_furniture": "Mobilier Int√©gr√©",
"accessories": "Accessoires",
"plumbings": "Plomberie",
"fire_protection": "Protection Incendie",
"lighting": "√âclairage",
"electrical_outlets": "Prises √âlectriques",
"communication_security": "Communication & S√©curit√©",
"medical_equipment": "√âquipements M√©dicaux",
"functionality": "Fonctionnalit√©",
"arch_requirements": "Exigences Architecturales",
"struct_requirements": "Exigences Structurales",
"risk_elements": "√âl√©ments √† Risque",
"ventilation_cvac": "Ventilation CVAC",
"electricity": "√âlectricit√©"
} %}

{% block title %}{{ project.name }} - Spacelogic{% endblock %}

{% block content %}
<!-- Workspace Secondary Navbar -->
<div class="workspace-navbar">
    <div class="workspace-navbar-container">
        <div class="workspace-nav-items">
            <a href="{{ url_for('workspace.projects') }}"
               class="workspace-nav-item {% if request.endpoint == 'workspace.projects' %}active{% endif %}">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                     stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                </svg>
                <span>Mes projets</span>
            </a>
            <a href="{{ url_for('workspace.organisations') }}"
               class="workspace-nav-item {% if request.endpoint == 'workspace.organisations' %}active{% endif %}">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                     stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"></path>
                    <circle cx="12" cy="8" r="2"></circle>
                    <path d="M12 10c-2.21 0-4 1.79-4 4v2h8v-2c0-2.21-1.79-4-4-4z"></path>
                </svg>
                <span>Organisations</span>
            </a>
        </div>
        <div class="workspace-context">
            {% block workspace_context %}{% endblock %}
        </div>
    </div>
</div>

<!-- Workspace Content Area -->
<div class="workspace-content">
    <!-- Project informations -->
    <div class="content">
        <div class="project-info-header">
            <div class="project-info-main">
                <div class="project-title-container">
                    <!-- Project logo near project name -->
                    <div class="project-title-with-logo">
                        <div class="project-type-logo">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                 fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                 stroke-linejoin="round">
                                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                            </svg>
                        </div>
                        <h1>{{ project.name }}</h1>
                    </div>
                    <div class="project-actions-dropdown">
                        <button class="dropdown-toggle">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="1"></circle>
                                <circle cx="12" cy="5" r="1"></circle>
                                <circle cx="12" cy="19" r="1"></circle>
                            </svg>
                        </button>
                        <div class="dropdown-menu">
                            <a href="{{ url_for('workspace.generate_pdf', project_id=project.id) }}" target="_blank">
                                üìÑ Rapport PDF
                            </a>
                            <a href="#" class="open-parameters-modal">
                                ‚öôÔ∏è Informations projet
                            </a>
                            <a href="#" class="dropdown-item manage-members-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="9" cy="7" r="4"></circle>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                </svg>
                                G√©rer les membres
                            </a>
                        </div>
                    </div>
                </div>

                <div class="project-number">
                    <span class="project-number-label">Num√©ro : </span>
                    <span>{{ project.project_number }}</span>
                </div>
            </div>
            <div class="project-info-details">
                <div class="info-item">
                    <div class="info-label">Description</div>
                    <div class="info-value">{{ project.description }}</div>
                </div>
                <div class="info-columns">
                    <div class="info-item">
                        <div class="info-label">Date de d√©but</div>
                        <div class="info-value">{{ project.start_date.strftime('%d/%m/%Y') if project.start_date else
                            'Non d√©finie' }}
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Date de fin</div>
                        <div class="info-value">{{ project.end_date.strftime('%d/%m/%Y') if project.end_date else 'Non
                            d√©finie' }}
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Type</div>
                        <div class="info-value">{{ project.type or 'Non d√©fini' }}</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="project-container">
            <!-- Menu tree -->
            <div class="sidebar">
                <h3 class="sidebar-title">Liste des pi√®ces</h3>

                {% if room_hierarchy %}
                <ul>
                    {% for functional_unit, sectors in room_hierarchy.items() %}
                    <li>
                        <span class="toggle folder-toggle">üìÇ <strong>{{ functional_unit }}</strong></span>
                        <ul class="nested">
                            {% for sector, rooms in sectors.items() %}
                            <li>
                                <span class="toggle folder-toggle">üìÅ <strong>{{ sector }}</strong></span>
                                <ul class="nested">
                                    {% for room in rooms %}
                                    <li class="room-item" data-room-id="{{ room.id }}" title="{{ room.name }}">{{
                                        room.name }}
                                    </li>
                                    {% endfor %}
                                </ul>
                            </li>
                            {% endfor %}
                        </ul>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p>Aucune pi√®ce disponible.</p>
                {% endif %}

                <!-- Add room button -->
                <div class="add-room-container">
                    <button id="add-room-btn" class="add-room-link">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Ajouter une pi√®ce
                    </button>
                </div>
            </div>

            <!-- Projects data -->
            <div class="content">
                <div class="room-info-panel" style="display: none;">
                    <div class="room-info-header">
                        <h2><span class="selected-room-title">Aucune pi√®ce de s√©lectionn√©e</span></h2>
                        <div class="project-actions-dropdown">
                            <button class="dropdown-toggle">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="1"></circle>
                                    <circle cx="12" cy="5" r="1"></circle>
                                    <circle cx="12" cy="19" r="1"></circle>
                                </svg>
                            </button>
                            <div class="dropdown-menu">
                                <a href="#" class="view-history-btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M12 2a10 10 0 1 0 10 10H12V2z"></path>
                                        <path d="M12 2v10h10"></path>
                                    </svg>
                                    Historique
                                </a>
                                <a href="#" class="edit-room-btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                    Modifier la pi√®ce
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="room-info-details">
                        <div class="info-item">
                            <div class="info-label">Unit√© fonctionnelle</div>
                            <div class="info-value selected-room-unit">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Secteur</div>
                            <div class="info-value selected-room-sector">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Superficie (m¬≤)</div>
                            <div class="info-value selected-room-area">-</div>
                        </div>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="tabs">
                    {% for category, title in tab_titles.items() %}
                    <button class="tab-button" data-tab="tab-{{ category }}">{{ title }}</button>
                    {% endfor %}
                </div>

                <!-- Tabs data -->
                <div class="tab-content-container">
                    {% for category, items in project_data.items() %}
                    <!--Functionality tab-->
                    {% if category == "functionality" %}
                    {% include "workspace/tabs/functionality_tab.html" %}

                    <!-- arch requirements tab-->
                    {% elif category == "arch_requirements" %}
                    {% include "workspace/tabs/arch_requirements_tab.html" %}

                    <!-- struct requirements tab -->
                    {% elif category == "struct_requirements" %}
                    {% include "workspace/tabs/struct_requirements_tab.html" %}

                    <!-- risk elements tab-->
                    {% elif category == "risk_elements" %}
                    {% include "workspace/tabs/risk_elements_tab.html" %}

                    <!-- ventilation cvac tab-->
                    {% elif category == "ventilation_cvac" %}
                    {% include "workspace/tabs/ventilation_cvac_tab.html" %}

                    <!-- electricity tab-->
                    {% elif category == "electricity" %}
                    {% include "workspace/tabs/electricity_tab.html" %}

                    <!--Normal tabs-->
                    {% else %}
                    <div id="tab-{{ category }}" class="tab-content {% if loop.first %}active{% endif %}">
                        <div class="tab-header">
                            <h2>{{ tab_titles.get(category, category.replace('_', ' ').capitalize()) }}</h2>
                            <div class="project-actions-dropdown">
                                <button class="dropdown-toggle">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="1"></circle>
                                        <circle cx="12" cy="5" r="1"></circle>
                                        <circle cx="12" cy="19" r="1"></circle>
                                    </svg>
                                </button>
                                <div class="dropdown-menu">
                                    <a href="#" class="add-item-button" data-category="{{ category }}">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                            <line x1="5" y1="12" x2="19" y2="12"></line>
                                        </svg>
                                        Ajouter un √©l√©ment
                                    </a>
                                    <a href="#" class="functionality-history-btn" data-category="{{ category }}">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M12 2a10 10 0 1 0 10 10H12V2z"></path>
                                            <path d="M12 2v10h10"></path>
                                        </svg>
                                        Historique
                                    </a>
                                </div>
                            </div>
                        </div>
                        <table>
                            <thead>
                            <tr>
                                {% for key in columns_to_display[category] if key in items[0] %}
                                <th class="sortable" data-column="{{ key }}" data-order="none">
                                    {{ column_titles.get(key, key) }}
                                    <span class="sort-icon">‚ÜïÔ∏è</span>
                                </th>
                                {% endfor %}

                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for item in items %}
                            <tr data-id="{{ item[category ~ '_id'] }}"
                                data-category="{{ category }}"
                                data-room-id="{{ item['room_id'] if 'room_id' in item else '' }}"
                                data-room-name="{{ item['room_name'] if 'room_name' in item else '' }}">

                                <!-- Not show room_id and room_name -->
                                <td style="display: none;">{{ item['room_id'] if 'room_id' in item else '' }}</td>
                                <td style="display: none;">{{ item['room_name'] if 'room_name' in item else '' }}</td>

                                {% for key in columns_to_display[category] if key in item %}
                                <td contenteditable="false" data-key="{{ key }}">{{ item[key] }}</td>
                                {% endfor %}
                                <td>
                                    <span class="edit-icon" title="Modifier">&#9998;</span>
                                    <span class="delete-icon" title="Supprimer">&#128465;</span>
                                </td>
                            </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block extra_js %}
<script>
    // Make columnsToDisplay globally available
    window.columnsToDisplay = {{ columns_to_display | tojson }};

    // Define a global app namespace to share data and functions between modules
    window.ProjectApp = {
        // Core data
        data: {
            selectedRoomId: null,
            selectedRoomName: null,
            editingRow: null,
            originalRowValues: new Map()
        },

        // Core DOM element references that will be needed across modules
        elements: {},

        // Function registry for cross-module access
        functions: {}
    };
</script>

<!-- Load JS files in the correct dependency order -->
<script src="{{ url_for('static', filename='js/project_detail/project_detail_main.js') }}"></script>
<script src="{{ url_for('static', filename='js/project_detail/room_data_handlers.js') }}"></script>
<script src="{{ url_for('static', filename='js/project_detail/table_editors.js') }}"></script>
<script src="{{ url_for('static', filename='js/project_detail/form_editors.js') }}"></script>
<script src="{{ url_for('static', filename='js/project_detail/modal_handlers.js') }}"></script>
<script src="{{ url_for('static', filename='js/entity_history.js') }}"></script>
{% endblock %}

{% block extra_css %}
{{ super() }}
<!-- Load our separated CSS file -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/project_detail.css') }}">

<!-- Include modals -->
{% include "workspace/room_creation_modal.html" %}
{% include "workspace/project_members_modal.html" %}
{% include "workspace/project_parameters_modal.html" %}
{% include "workspace/room_history_modal.html" %}
{% include "workspace/entity_history_modal.html" %}
{% endblock %}
