<!-- Project Members Modal -->
<div id="project-members-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Membres du projet</h2>
            <button class="close-modal-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="members-section">
                <h3>Membres actuels</h3>
                <div class="members-list">
                    {% if project_members %}
                        <table class="members-table">
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th>Prénom</th>
                                    <th>Email</th>
                                    <th>Rôle</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for member in project_members %}
                                <tr>
                                    <td>{{ member.last_name }}</td>
                                    <td>{{ member.first_name }}</td>
                                    <td>{{ member.email }}</td>
                                    <td>{{ member.role|default('Membre') }}</td>
                                    <td>
                                        <button class="action-btn remove-member-btn" data-id="{{ member.id }}" data-name="{{ member.first_name }} {{ member.last_name }}">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <polyline points="3 6 5 6 21 6"></polyline>
                                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                            </svg>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p class="empty-members">Aucun membre n'a encore été ajouté à ce projet.</p>
                    {% endif %}
                </div>
            </div>

            <div class="add-member-section">
                <h3>Ajouter un membre</h3>
                <form id="add-member-form">
                    <!-- Error container will appear here when needed -->
                    <div class="form-group">
                        <label for="user-select">Sélectionner un utilisateur</label>
                        <select id="user-select" name="user_id" required>
                            <option value="">-- Sélectionner un utilisateur --</option>
                            {% if available_users %}
                                {% for user in available_users %}
                                    <option value="{{ user.id }}">{{ user.first_name }} {{ user.last_name }} ({{ user.email }})</option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="member-role">Rôle dans le projet</label>
                        <select id="member-role" name="role">
                            <option value="Membre">Membre</option>
                            <option value="Collaborateur">Collaborateur</option>
                            <option value="Client">Client</option>
                            <option value="Administrateur">Administrateur</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary cancel-btn">Annuler</button>
                        <button type="submit" class="btn btn-primary add-btn">
                            <span class="btn-text">Ajouter</span>
                            <span class="btn-spinner" style="display: none;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="spin">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <path d="M12 6v6l4 2"></path>
                                </svg>
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get modal elements
    const modal = document.getElementById('project-members-modal');
    const openModalBtns = document.querySelectorAll('.open-members-modal-btn');
    const closeButton = document.querySelector('#project-members-modal .close-modal-btn');
    const cancelButton = document.querySelector('#project-members-modal .cancel-btn');
    const form = document.getElementById('add-member-form');

    // Open modal when the open modal button is clicked
    if (openModalBtns) {
        openModalBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                modal.classList.add('active');
            });
        });
    }

    // Close modal when close button is clicked
    if (closeButton) {
        closeButton.addEventListener('click', function() {
            modal.classList.remove('active');
        });
    }

    // Close modal when cancel button is clicked
    if (cancelButton) {
        cancelButton.addEventListener('click', function() {
            modal.classList.remove('active');
        });
    }

    // Close modal when clicking outside the modal content
    window.addEventListener('click', function(event) {
        if (event.target === modal) {
            modal.classList.remove('active');
        }
    });

    // Handle form submission
    if (form) {
        form.addEventListener('submit', function(event) {
            event.preventDefault();

            // Get the project ID from the URL
            const urlParts = window.location.pathname.split('/');
            const projectId = urlParts[urlParts.length - 1]; // Assuming the URL format is /workspace/projects/[project_id]

            // Get submit button elements
            const submitButton = form.querySelector('.add-btn');
            const buttonText = submitButton.querySelector('.btn-text');
            const buttonSpinner = submitButton.querySelector('.btn-spinner');

            // Show loading state
            submitButton.disabled = true;
            buttonText.style.display = 'none';
            buttonSpinner.style.display = 'inline-block';

            // Remove any existing error messages
            const existingError = form.querySelector('.form-error');
            if (existingError) {
                existingError.remove();
            }

            // Get form data and convert to JSON
            const formData = new FormData(form);
            const memberData = {
                user_id: formData.get('user_id'),
                role: formData.get('role')
            };

            // Send request to add member to project using the API
            fetch(`/api/projects/${projectId}/members`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(memberData),
                credentials: 'same-origin' // Include cookies
            })
            .then(response => {
                // Always parse JSON first to get any error message
                return response.json().then(data => {
                    if (!response.ok) {
                        throw new Error(data.message || `HTTP error ${response.status}`);
                    }
                    return data;
                });
            })
            .then(data => {
                if (data.success) {
                    // Show success toast
                    if (window.toast) {
                        window.toast.success(`Membre ajouté avec succès!`);
                    }

                    // Reset form
                    form.reset();

                    // Reload the page to show new member
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    throw new Error(data.message || 'Une erreur est survenue');
                }
            })
            .catch(error => {
                console.error('Error adding member:', error);

                // Reset button state
                submitButton.disabled = false;
                buttonText.style.display = 'inline';
                buttonSpinner.style.display = 'none';

                // Create error message
                const errorDiv = document.createElement('div');
                errorDiv.className = 'form-error';
                errorDiv.textContent = error.message || 'Une erreur est survenue lors de l\'ajout du membre. Veuillez réessayer.';

                // Add the error at the top of the form
                form.prepend(errorDiv);

                // Show error toast
                if (window.toast) {
                    window.toast.error(error.message || 'Une erreur est survenue lors de l\'ajout du membre');
                }
            });
        });
    }

    // Handle remove member button clicks
    const removeButtons = document.querySelectorAll('.remove-member-btn');
    removeButtons.forEach(button => {
        button.addEventListener('click', function() {
            const userId = this.getAttribute('data-id');
            const userName = this.getAttribute('data-name');
            
            if (confirm(`Êtes-vous sûr de vouloir retirer ${userName} de ce projet?`)) {
                // Get the project ID from the URL
                const urlParts = window.location.pathname.split('/');
                const projectId = urlParts[urlParts.length - 1];
                
                // Show loading state
                this.disabled = true;
                this.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="spin">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <path d="M12 6v6l4 2"></path>
                                  </svg>`;
                
                // Send request to remove member from project
                fetch(`/api/projects/${projectId}/members/${userId}`, {
                    method: 'DELETE',
                    credentials: 'same-origin'
                })
                .then(response => {
                    // Parse JSON response
                    return response.json().then(data => {
                        if (!response.ok) {
                            throw new Error(data.message || `HTTP error ${response.status}`);
                        }
                        return data;
                    });
                })
                .then(data => {
                    if (data.success) {
                        // Show success toast
                        if (window.toast) {
                            window.toast.success(`Membre retiré avec succès!`);
                        }
                        
                        // Reload the page to update the member list
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        throw new Error(data.message || 'Une erreur est survenue');
                    }
                })
                .catch(error => {
                    console.error('Error removing member:', error);
                    
                    // Reset button state
                    this.disabled = false;
                    this.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                      </svg>`;
                    
                    // Show error toast
                    if (window.toast) {
                        window.toast.error(error.message || 'Une erreur est survenue lors du retrait du membre');
                    }
                });
            }
        });
    });
});
</script>

<style>
/* Members table styles */
.members-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
}

.members-table th,
.members-table td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid #e2e8f0;
}

.members-table th {
    font-weight: 600;
    color: #4a5568;
    background-color: #f8fafc;
}

.action-btn {
    background: none;
    border: none;
    cursor: pointer;
    color: #a0aec0;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 5px;
    border-radius: 4px;
    transition: all 0.2s ease;
}

.action-btn:hover {
    background-color: #f7fafc;
}

.remove-member-btn:hover {
    color: #e53e3e;
}

.members-section,
.add-member-section {
    margin-bottom: 30px;
}

.members-section h3,
.add-member-section h3 {
    margin-top: 0;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #e2e8f0;
    font-size: 1.1rem;
    color: #2d3748;
}

.empty-members {
    padding: 20px;
    text-align: center;
    background-color: #f8fafc;
    border-radius: 6px;
    color: #718096;
}
</style>